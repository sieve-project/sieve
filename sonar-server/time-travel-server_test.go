package main

import (
	"encoding/json"
	"log"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestIsCrucial(t *testing.T) {
	log.SetFlags(log.LstdFlags | log.Lshortfile)
	crucialEvent := `{"spec": {"nodeName": "SIEVE-NON-NIL"}, "status": {"conditions": [{"type":
	"PodScheduled", "status": "True", "lastProbeTime": null, "lastTransitionTime": "SIEVE-NON-NIL"}]}}`
	currentEvent := `{"name":"mongodb-cluster-cfg-1","generateName":"mongodb-cluster-cfg-","namespace":"default","uid":"f42f5c0e-4ff7-41f9-b27e-adf154316e3d","resourceVersion":"1681","creationTimestamp":"2021-06-06T08:22:17Z","labels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg","controller-revision-hash":"mongodb-cluster-cfg-b7b5fb94","statefulset.kubernetes.io/pod-name":"mongodb-cluster-cfg-1"},"annotations":{"percona.com/ssl-hash":"55b9aa7cf78275dc3b73d0623c7813ad","percona.com/ssl-internal-hash":"84921b557019efa23be696fceb011ce6"},"ownerReferences":[{"apiVersion":"apps/v1","kind":"StatefulSet","name":"mongodb-cluster-cfg","uid":"38392e90-13c0-42d1-a5ac-5e11870a381a","controller":true,"blockOwnerDeletion":true}],"managedFields":[{"manager":"kube-controller-manager","operation":"Update","apiVersion":"v1","time":"2021-06-06T08:22:17Z","fieldsType":"FieldsV1","fieldsV1":{"f:metadata":{"f:annotations":{".":{},"f:percona.com/ssl-hash":{},"f:percona.com/ssl-internal-hash":{}},"f:generateName":{},"f:labels":{".":{},"f:app.kubernetes.io/component":{},"f:app.kubernetes.io/instance":{},"f:app.kubernetes.io/managed-by":{},"f:app.kubernetes.io/name":{},"f:app.kubernetes.io/part-of":{},"f:app.kubernetes.io/replset":{},"f:controller-revision-hash":{},"f:statefulset.kubernetes.io/pod-name":{}},"f:ownerReferences":{".":{},"k:{\"uid\":\"38392e90-13c0-42d1-a5ac-5e11870a381a\"}":{".":{},"f:apiVersion":{},"f:blockOwnerDeletion":{},"f:controller":{},"f:kind":{},"f:name":{},"f:uid":{}}}},"f:spec":{"f:affinity":{".":{},"f:podAntiAffinity":{".":{},"f:requiredDuringSchedulingIgnoredDuringExecution":{}}},"f:containers":{"k:{\"name\":\"mongod\"}":{".":{},"f:args":{},"f:command":{},"f:env":{".":{},"k:{\"name\":\"MONGODB_PORT\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"MONGODB_REPLSET\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"NAMESPACE\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"SERVICE_NAME\"}":{".":{},"f:name":{},"f:value":{}}},"f:envFrom":{},"f:image":{},"f:imagePullPolicy":{},"f:livenessProbe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:timeoutSeconds":{}},"f:name":{},"f:ports":{".":{},"k:{\"containerPort\":27017,\"protocol\":\"TCP\"}":{".":{},"f:containerPort":{},"f:name":{},"f:protocol":{}}},"f:readinessProbe":{".":{},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:tcpSocket":{".":{},"f:port":{}},"f:timeoutSeconds":{}},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:securityContext":{".":{},"f:runAsNonRoot":{},"f:runAsUser":{}},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{},"f:volumeMounts":{".":{},"k:{\"mountPath\":\"/data/db\"}":{".":{},"f:mountPath":{},"f:name":{}},"k:{\"mountPath\":\"/etc/mongodb-encryption\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-secrets\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-ssl\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-ssl-internal\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}}},"f:workingDir":{}}},"f:dnsPolicy":{},"f:enableServiceLinks":{},"f:hostname":{},"f:initContainers":{".":{},"k:{\"name\":\"mongo-init\"}":{".":{},"f:command":{},"f:image":{},"f:imagePullPolicy":{},"f:name":{},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{},"f:volumeMounts":{".":{},"k:{\"mountPath\":\"/data/db\"}":{".":{},"f:mountPath":{},"f:name":{}}}}},"f:restartPolicy":{},"f:schedulerName":{},"f:securityContext":{".":{},"f:fsGroup":{}},"f:serviceAccount":{},"f:serviceAccountName":{},"f:subdomain":{},"f:terminationGracePeriodSeconds":{},"f:volumes":{".":{},"k:{\"name\":\"mongod-data\"}":{".":{},"f:name":{},"f:persistentVolumeClaim":{".":{},"f:claimName":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-encryption-key\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-keyfile\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"ssl\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"ssl-internal\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}}}}}}],"Spec":{"Volumes":[{"Name":"mongod-data","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":null,"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":{"ClaimName":"mongod-data-mongodb-cluster-cfg-1","ReadOnly":false},"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"mongodb-cluster-mongodb-keyfile","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-mongodb-keyfile","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"mongodb-cluster-mongodb-encryption-key","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-mongodb-encryption-key","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"ssl","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-ssl","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"ssl-internal","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-ssl-internal","Items":null,"DefaultMode":288,"Optional":true},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"default-token-xvwsw","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"default-token-xvwsw","Items":null,"DefaultMode":420,"Optional":null},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null}],"InitContainers":[{"Name":"mongo-init","Image":"laphets/mongodb-operator:time-travel","Command":["/init-entrypoint.sh"],"Args":null,"WorkingDir":"","Ports":null,"EnvFrom":null,"Env":null,"Resources":{"Limits":{"cpu":"300m","memory":"500M"},"Requests":{"cpu":"300m","memory":"500M"}},"VolumeMounts":[{"Name":"mongod-data","ReadOnly":false,"MountPath":"/data/db","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"default-token-xvwsw","ReadOnly":true,"MountPath":"/var/run/secrets/kubernetes.io/serviceaccount","SubPath":"","MountPropagation":null,"SubPathExpr":""}],"VolumeDevices":null,"LivenessProbe":null,"ReadinessProbe":null,"StartupProbe":null,"Lifecycle":null,"TerminationMessagePath":"/dev/termination-log","TerminationMessagePolicy":"File","ImagePullPolicy":"Always","SecurityContext":null,"Stdin":false,"StdinOnce":false,"TTY":false}],"Containers":[{"Name":"mongod","Image":"percona/percona-server-mongodb:4.4.3-5","Command":["/data/db/ps-entry.sh"],"Args":["--bind_ip_all","--auth","--dbpath=/data/db","--port=27017","--replSet=cfg","--storageEngine=wiredTiger","--relaxPermChecks","--sslAllowInvalidCertificates","--sslMode=preferSSL","--clusterAuthMode=x509","--configsvr","--slowms=100","--profile=1","--rateLimit=100","--enableEncryption","--encryptionKeyFile=/etc/mongodb-encryption/encryption-key","--encryptionCipherMode=AES256-CBC","--wiredTigerCacheSizeGB=0.25","--wiredTigerCollectionBlockCompressor=snappy","--wiredTigerJournalCompressor=snappy","--wiredTigerIndexPrefixCompression=true","--setParameter","ttlMonitorSleepSecs=60","--setParameter","wiredTigerConcurrentReadTransactions=128","--setParameter","wiredTigerConcurrentWriteTransactions=128"],"WorkingDir":"/data/db","Ports":[{"Name":"mongodb","HostPort":0,"ContainerPort":27017,"Protocol":"TCP","HostIP":""}],"EnvFrom":[{"Prefix":"","ConfigMapRef":null,"SecretRef":{"Name":"internal-mongodb-cluster-users","Optional":false}}],"Env":[{"Name":"SERVICE_NAME","Value":"mongodb-cluster","ValueFrom":null},{"Name":"NAMESPACE","Value":"default","ValueFrom":null},{"Name":"MONGODB_PORT","Value":"27017","ValueFrom":null},{"Name":"MONGODB_REPLSET","Value":"cfg","ValueFrom":null}],"Resources":{"Limits":{"cpu":"300m","memory":"500M"},"Requests":{"cpu":"300m","memory":"500M"}},"VolumeMounts":[{"Name":"mongod-data","ReadOnly":false,"MountPath":"/data/db","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"mongodb-cluster-mongodb-keyfile","ReadOnly":true,"MountPath":"/etc/mongodb-secrets","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"ssl","ReadOnly":true,"MountPath":"/etc/mongodb-ssl","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"ssl-internal","ReadOnly":true,"MountPath":"/etc/mongodb-ssl-internal","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"mongodb-cluster-mongodb-encryption-key","ReadOnly":true,"MountPath":"/etc/mongodb-encryption","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"default-token-xvwsw","ReadOnly":true,"MountPath":"/var/run/secrets/kubernetes.io/serviceaccount","SubPath":"","MountPropagation":null,"SubPathExpr":""}],"VolumeDevices":null,"LivenessProbe":{"Exec":{"Command":["/data/db/mongodb-healthcheck","k8s","liveness","--ssl","--sslInsecure","--sslCAFile","/etc/mongodb-ssl/ca.crt","--sslPEMKeyFile","/tmp/tls.pem","--startupDelaySeconds","7200"]},"HTTPGet":null,"TCPSocket":null,"InitialDelaySeconds":60,"TimeoutSeconds":5,"PeriodSeconds":30,"SuccessThreshold":1,"FailureThreshold":4},"ReadinessProbe":{"Exec":null,"HTTPGet":null,"TCPSocket":{"Port":27017,"Host":""},"InitialDelaySeconds":10,"TimeoutSeconds":2,"PeriodSeconds":3,"SuccessThreshold":1,"FailureThreshold":8},"StartupProbe":null,"Lifecycle":null,"TerminationMessagePath":"/dev/termination-log","TerminationMessagePolicy":"File","ImagePullPolicy":"Always","SecurityContext":{"Capabilities":null,"Privileged":null,"SELinuxOptions":null,"WindowsOptions":null,"RunAsUser":1001,"RunAsGroup":null,"RunAsNonRoot":true,"ReadOnlyRootFilesystem":null,"AllowPrivilegeEscalation":null,"ProcMount":null},"Stdin":false,"StdinOnce":false,"TTY":false}],"EphemeralContainers":null,"RestartPolicy":"Always","TerminationGracePeriodSeconds":30,"ActiveDeadlineSeconds":null,"DNSPolicy":"ClusterFirst","NodeSelector":null,"ServiceAccountName":"default","AutomountServiceAccountToken":null,"NodeName":"kind-worker","SecurityContext":{"HostNetwork":false,"HostPID":false,"HostIPC":false,"ShareProcessNamespace":null,"SELinuxOptions":null,"WindowsOptions":null,"RunAsUser":null,"RunAsGroup":null,"RunAsNonRoot":null,"SupplementalGroups":null,"FSGroup":1001,"FSGroupChangePolicy":null,"Sysctls":null},"ImagePullSecrets":null,"Hostname":"mongodb-cluster-cfg-1","Subdomain":"mongodb-cluster-cfg","Affinity":{"NodeAffinity":null,"PodAffinity":null,"PodAntiAffinity":{"RequiredDuringSchedulingIgnoredDuringExecution":[{"LabelSelector":{"matchLabels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg"}},"Namespaces":null,"TopologyKey":"kubernetes.io/hostname"}],"PreferredDuringSchedulingIgnoredDuringExecution":null}},"SchedulerName":"default-scheduler","Tolerations":[{"Key":"node.kubernetes.io/not-ready","Operator":"Exists","Value":"","Effect":"NoExecute","TolerationSeconds":300},{"Key":"node.kubernetes.io/unreachable","Operator":"Exists","Value":"","Effect":"NoExecute","TolerationSeconds":300}],"HostAliases":null,"PriorityClassName":"","Priority":0,"PreemptionPolicy":null,"DNSConfig":null,"ReadinessGates":null,"RuntimeClassName":null,"Overhead":null,"EnableServiceLinks":true,"TopologySpreadConstraints":null},"Status":{"Phase":"Pending","Conditions":[{"Type":"PodScheduled","Status":"True","LastProbeTime":null,"LastTransitionTime":"2021-06-06T08:22:20Z","Reason":"","Message":""}],"Message":"","Reason":"","NominatedNodeName":"","HostIP":"","PodIPs":null,"StartTime":null,"QOSClass":"Guaranteed","InitContainerStatuses":null,"ContainerStatuses":null,"EphemeralContainerStatuses":null}}`
	currentEventLower := `{"annotations":{"percona.com/ssl-hash":"55b9aa7cf78275dc3b73d0623c7813ad","percona.com/ssl-internal-hash":"84921b557019efa23be696fceb011ce6"},"creationtimestamp":"2021-06-06T08:22:17Z","generatename":"mongodb-cluster-cfg-","labels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg","controller-revision-hash":"mongodb-cluster-cfg-b7b5fb94","statefulset.kubernetes.io/pod-name":"mongodb-cluster-cfg-1"},"managedfields":[{"apiversion":"v1","fieldstype":"FieldsV1","fieldsv1":{"f:metadata":{"f:annotations":{".":{},"f:percona.com/ssl-hash":{},"f:percona.com/ssl-internal-hash":{}},"f:generatename":{},"f:labels":{".":{},"f:app.kubernetes.io/component":{},"f:app.kubernetes.io/instance":{},"f:app.kubernetes.io/managed-by":{},"f:app.kubernetes.io/name":{},"f:app.kubernetes.io/part-of":{},"f:app.kubernetes.io/replset":{},"f:controller-revision-hash":{},"f:statefulset.kubernetes.io/pod-name":{}},"f:ownerreferences":{".":{},"k:{\"uid\":\"38392e90-13c0-42d1-a5ac-5e11870a381a\"}":{".":{},"f:apiversion":{},"f:blockownerdeletion":{},"f:controller":{},"f:kind":{},"f:name":{},"f:uid":{}}}},"f:spec":{"f:affinity":{".":{},"f:podantiaffinity":{".":{},"f:requiredduringschedulingignoredduringexecution":{}}},"f:containers":{"k:{\"name\":\"mongod\"}":{".":{},"f:args":{},"f:command":{},"f:env":{".":{},"k:{\"name\":\"mongodb_port\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"mongodb_replset\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"namespace\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"service_name\"}":{".":{},"f:name":{},"f:value":{}}},"f:envfrom":{},"f:image":{},"f:imagepullpolicy":{},"f:livenessprobe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failurethreshold":{},"f:initialdelayseconds":{},"f:periodseconds":{},"f:successthreshold":{},"f:timeoutseconds":{}},"f:name":{},"f:ports":{".":{},"k:{\"containerport\":27017,\"protocol\":\"tcp\"}":{".":{},"f:containerport":{},"f:name":{},"f:protocol":{}}},"f:readinessprobe":{".":{},"f:failurethreshold":{},"f:initialdelayseconds":{},"f:periodseconds":{},"f:successthreshold":{},"f:tcpsocket":{".":{},"f:port":{}},"f:timeoutseconds":{}},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:securitycontext":{".":{},"f:runasnonroot":{},"f:runasuser":{}},"f:terminationmessagepath":{},"f:terminationmessagepolicy":{},"f:volumemounts":{".":{},"k:{\"mountpath\":\"/data/db\"}":{".":{},"f:mountpath":{},"f:name":{}},"k:{\"mountpath\":\"/etc/mongodb-encryption\"}":{".":{},"f:mountpath":{},"f:name":{},"f:readonly":{}},"k:{\"mountpath\":\"/etc/mongodb-secrets\"}":{".":{},"f:mountpath":{},"f:name":{},"f:readonly":{}},"k:{\"mountpath\":\"/etc/mongodb-ssl\"}":{".":{},"f:mountpath":{},"f:name":{},"f:readonly":{}},"k:{\"mountpath\":\"/etc/mongodb-ssl-internal\"}":{".":{},"f:mountpath":{},"f:name":{},"f:readonly":{}}},"f:workingdir":{}}},"f:dnspolicy":{},"f:enableservicelinks":{},"f:hostname":{},"f:initcontainers":{".":{},"k:{\"name\":\"mongo-init\"}":{".":{},"f:command":{},"f:image":{},"f:imagepullpolicy":{},"f:name":{},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:terminationmessagepath":{},"f:terminationmessagepolicy":{},"f:volumemounts":{".":{},"k:{\"mountpath\":\"/data/db\"}":{".":{},"f:mountpath":{},"f:name":{}}}}},"f:restartpolicy":{},"f:schedulername":{},"f:securitycontext":{".":{},"f:fsgroup":{}},"f:serviceaccount":{},"f:serviceaccountname":{},"f:subdomain":{},"f:terminationgraceperiodseconds":{},"f:volumes":{".":{},"k:{\"name\":\"mongod-data\"}":{".":{},"f:name":{},"f:persistentvolumeclaim":{".":{},"f:claimname":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-encryption-key\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultmode":{},"f:optional":{},"f:secretname":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-keyfile\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultmode":{},"f:optional":{},"f:secretname":{}}},"k:{\"name\":\"ssl\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultmode":{},"f:optional":{},"f:secretname":{}}},"k:{\"name\":\"ssl-internal\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultmode":{},"f:optional":{},"f:secretname":{}}}}}},"manager":"kube-controller-manager","operation":"Update","time":"2021-06-06T08:22:17Z"}],"name":"mongodb-cluster-cfg-1","namespace":"default","ownerreferences":[{"apiversion":"apps/v1","blockownerdeletion":true,"controller":true,"kind":"StatefulSet","name":"mongodb-cluster-cfg","uid":"38392e90-13c0-42d1-a5ac-5e11870a381a"}],"resourceversion":"1681","spec":{"activedeadlineseconds":null,"affinity":{"nodeaffinity":null,"podaffinity":null,"podantiaffinity":{"preferredduringschedulingignoredduringexecution":null,"requiredduringschedulingignoredduringexecution":[{"labelselector":{"matchlabels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg"}},"namespaces":null,"topologykey":"kubernetes.io/hostname"}]}},"automountserviceaccounttoken":null,"containers":[{"args":["--bind_ip_all","--auth","--dbpath=/data/db","--port=27017","--replSet=cfg","--storageEngine=wiredTiger","--relaxPermChecks","--sslAllowInvalidCertificates","--sslMode=preferSSL","--clusterAuthMode=x509","--configsvr","--slowms=100","--profile=1","--rateLimit=100","--enableEncryption","--encryptionKeyFile=/etc/mongodb-encryption/encryption-key","--encryptionCipherMode=AES256-CBC","--wiredTigerCacheSizeGB=0.25","--wiredTigerCollectionBlockCompressor=snappy","--wiredTigerJournalCompressor=snappy","--wiredTigerIndexPrefixCompression=true","--setParameter","ttlMonitorSleepSecs=60","--setParameter","wiredTigerConcurrentReadTransactions=128","--setParameter","wiredTigerConcurrentWriteTransactions=128"],"command":["/data/db/ps-entry.sh"],"env":[{"name":"SERVICE_NAME","value":"mongodb-cluster","valuefrom":null},{"name":"NAMESPACE","value":"default","valuefrom":null},{"name":"MONGODB_PORT","value":"27017","valuefrom":null},{"name":"MONGODB_REPLSET","value":"cfg","valuefrom":null}],"envfrom":[{"configmapref":null,"prefix":"","secretref":{"name":"internal-mongodb-cluster-users","optional":false}}],"image":"percona/percona-server-mongodb:4.4.3-5","imagepullpolicy":"Always","lifecycle":null,"livenessprobe":{"exec":{"command":["/data/db/mongodb-healthcheck","k8s","liveness","--ssl","--sslInsecure","--sslCAFile","/etc/mongodb-ssl/ca.crt","--sslPEMKeyFile","/tmp/tls.pem","--startupDelaySeconds","7200"]},"failurethreshold":4,"httpget":null,"initialdelayseconds":60,"periodseconds":30,"successthreshold":1,"tcpsocket":null,"timeoutseconds":5},"name":"mongod","ports":[{"containerport":27017,"hostip":"","hostport":0,"name":"mongodb","protocol":"TCP"}],"readinessprobe":{"exec":null,"failurethreshold":8,"httpget":null,"initialdelayseconds":10,"periodseconds":3,"successthreshold":1,"tcpsocket":{"host":"","port":27017},"timeoutseconds":2},"resources":{"limits":{"cpu":"300m","memory":"500M"},"requests":{"cpu":"300m","memory":"500M"}},"securitycontext":{"allowprivilegeescalation":null,"capabilities":null,"privileged":null,"procmount":null,"readonlyrootfilesystem":null,"runasgroup":null,"runasnonroot":true,"runasuser":1001,"selinuxoptions":null,"windowsoptions":null},"startupprobe":null,"stdin":false,"stdinonce":false,"terminationmessagepath":"/dev/termination-log","terminationmessagepolicy":"File","tty":false,"volumedevices":null,"volumemounts":[{"mountpath":"/data/db","mountpropagation":null,"name":"mongod-data","readonly":false,"subpath":"","subpathexpr":""},{"mountpath":"/etc/mongodb-secrets","mountpropagation":null,"name":"mongodb-cluster-mongodb-keyfile","readonly":true,"subpath":"","subpathexpr":""},{"mountpath":"/etc/mongodb-ssl","mountpropagation":null,"name":"ssl","readonly":true,"subpath":"","subpathexpr":""},{"mountpath":"/etc/mongodb-ssl-internal","mountpropagation":null,"name":"ssl-internal","readonly":true,"subpath":"","subpathexpr":""},{"mountpath":"/etc/mongodb-encryption","mountpropagation":null,"name":"mongodb-cluster-mongodb-encryption-key","readonly":true,"subpath":"","subpathexpr":""},{"mountpath":"/var/run/secrets/kubernetes.io/serviceaccount","mountpropagation":null,"name":"default-token-xvwsw","readonly":true,"subpath":"","subpathexpr":""}],"workingdir":"/data/db"}],"dnsconfig":null,"dnspolicy":"ClusterFirst","enableservicelinks":true,"ephemeralcontainers":null,"hostaliases":null,"hostname":"mongodb-cluster-cfg-1","imagepullsecrets":null,"initcontainers":[{"args":null,"command":["/init-entrypoint.sh"],"env":null,"envfrom":null,"image":"laphets/mongodb-operator:time-travel","imagepullpolicy":"Always","lifecycle":null,"livenessprobe":null,"name":"mongo-init","ports":null,"readinessprobe":null,"resources":{"limits":{"cpu":"300m","memory":"500M"},"requests":{"cpu":"300m","memory":"500M"}},"securitycontext":null,"startupprobe":null,"stdin":false,"stdinonce":false,"terminationmessagepath":"/dev/termination-log","terminationmessagepolicy":"File","tty":false,"volumedevices":null,"volumemounts":[{"mountpath":"/data/db","mountpropagation":null,"name":"mongod-data","readonly":false,"subpath":"","subpathexpr":""},{"mountpath":"/var/run/secrets/kubernetes.io/serviceaccount","mountpropagation":null,"name":"default-token-xvwsw","readonly":true,"subpath":"","subpathexpr":""}],"workingdir":""}],"nodename":"kind-worker","nodeselector":null,"overhead":null,"preemptionpolicy":null,"priority":0,"priorityclassname":"","readinessgates":null,"restartpolicy":"Always","runtimeclassname":null,"schedulername":"default-scheduler","securitycontext":{"fsgroup":1001,"fsgroupchangepolicy":null,"hostipc":false,"hostnetwork":false,"hostpid":false,"runasgroup":null,"runasnonroot":null,"runasuser":null,"selinuxoptions":null,"shareprocessnamespace":null,"supplementalgroups":null,"sysctls":null,"windowsoptions":null},"serviceaccountname":"default","subdomain":"mongodb-cluster-cfg","terminationgraceperiodseconds":30,"tolerations":[{"effect":"NoExecute","key":"node.kubernetes.io/not-ready","operator":"Exists","tolerationseconds":300,"value":""},{"effect":"NoExecute","key":"node.kubernetes.io/unreachable","operator":"Exists","tolerationseconds":300,"value":""}],"topologyspreadconstraints":null,"volumes":[{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"mongod-data","nfs":null,"persistentvolumeclaim":{"claimname":"mongod-data-mongodb-cluster-cfg-1","readonly":false},"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":null,"storageos":null,"vspherevolume":null},{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"mongodb-cluster-mongodb-keyfile","nfs":null,"persistentvolumeclaim":null,"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":{"defaultmode":288,"items":null,"optional":false,"secretname":"mongodb-cluster-mongodb-keyfile"},"storageos":null,"vspherevolume":null},{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"mongodb-cluster-mongodb-encryption-key","nfs":null,"persistentvolumeclaim":null,"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":{"defaultmode":288,"items":null,"optional":false,"secretname":"mongodb-cluster-mongodb-encryption-key"},"storageos":null,"vspherevolume":null},{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"ssl","nfs":null,"persistentvolumeclaim":null,"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":{"defaultmode":288,"items":null,"optional":false,"secretname":"mongodb-cluster-ssl"},"storageos":null,"vspherevolume":null},{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"ssl-internal","nfs":null,"persistentvolumeclaim":null,"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":{"defaultmode":288,"items":null,"optional":true,"secretname":"mongodb-cluster-ssl-internal"},"storageos":null,"vspherevolume":null},{"awselasticblockstore":null,"azuredisk":null,"azurefile":null,"cephfs":null,"cinder":null,"configmap":null,"csi":null,"downwardapi":null,"emptydir":null,"fc":null,"flexvolume":null,"flocker":null,"gcepersistentdisk":null,"gitrepo":null,"glusterfs":null,"hostpath":null,"iscsi":null,"name":"default-token-xvwsw","nfs":null,"persistentvolumeclaim":null,"photonpersistentdisk":null,"portworxvolume":null,"projected":null,"quobyte":null,"rbd":null,"scaleio":null,"secret":{"defaultmode":420,"items":null,"optional":null,"secretname":"default-token-xvwsw"},"storageos":null,"vspherevolume":null}]},"status":{"conditions":[{"lastprobetime":null,"lasttransitiontime":"2021-06-06T08:22:20Z","message":"","reason":"","status":"True","type":"PodScheduled"}],"containerstatuses":null,"ephemeralcontainerstatuses":null,"hostip":"","initcontainerstatuses":null,"message":"","nominatednodename":"","phase":"Pending","podips":null,"qosclass":"Guaranteed","reason":"","starttime":null},"uid":"f42f5c0e-4ff7-41f9-b27e-adf154316e3d"}`
	assert.True(t, isCrucial(strToMap(crucialEvent), strToMap(currentEvent)), "Crucial event detect fail")

	transformedJson, err := json.Marshal(strToMap(currentEvent))
	assert.Equal(t, err, nil)
	assert.Equal(t, string(transformedJson), currentEventLower)
}

func TestIsCrucialNew(t *testing.T) {
	log.SetFlags(log.LstdFlags | log.Lshortfile)
	crucialEvent := `{"spec": {"persistence": {"storage": "15Gi"}}}`
	currentEvent := `{"metadata":{"name":"rabbitmq-cluster","namespace":"default","selfLink":"/apis/rabbitmq.com/v1beta1/namespaces/default/rabbitmqclusters/rabbitmq-cluster","uid":"a579755c-1330-4eec-9801-6d5f9201da7f","resourceVersion":"1739","generation":3,"creationTimestamp":"2021-06-22T07:31:56Z","annotations":{"kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"rabbitmq.com/v1beta1\",\"kind\":\"RabbitmqCluster\",\"metadata\":{\"annotations\":{},\"name\":\"rabbitmq-cluster\",\"namespace\":\"default\"},\"spec\":{\"persistence\":{\"storage\":\"10Gi\"},\"replicas\":1}}\n"},"finalizers":["deletion.finalizers.rabbitmqclusters.rabbitmq.com"],"managedFields":[{"manager":"manager","operation":"Update","apiVersion":"rabbitmq.com/v1beta1","time":"2021-06-22T07:33:06Z","fieldsType":"FieldsV1","fieldsV1":{"f:metadata":{"f:finalizers":{}},"f:spec":{"f:override":{},"f:rabbitmq":{},"f:resources":{"f:limits":{"f:cpu":{}},"f:requests":{"f:cpu":{}}},"f:tls":{}},"f:status":{".":{},"f:conditions":{},"f:defaultUser":{".":{},"f:secretReference":{".":{},"f:keys":{".":{},"f:password":{},"f:username":{}},"f:name":{},"f:namespace":{}},"f:serviceReference":{".":{},"f:name":{},"f:namespace":{}}}}}},{"manager":"kubectl","operation":"Update","apiVersion":"rabbitmq.com/v1beta1","time":"2021-06-22T07:33:09Z","fieldsType":"FieldsV1","fieldsV1":{"f:metadata":{"f:annotations":{".":{},"f:kubectl.kubernetes.io/last-applied-configuration":{}}},"f:spec":{".":{},"f:image":{},"f:persistence":{".":{},"f:storage":{}},"f:replicas":{},"f:resources":{".":{},"f:limits":{".":{},"f:memory":{}},"f:requests":{".":{},"f:memory":{}}},"f:service":{".":{},"f:type":{}},"f:terminationGracePeriodSeconds":{}}}}]},"spec":{"replicas":1,"image":"rabbitmq:3.8.12-management","service":{"type":"ClusterIP"},"persistence":{"storage":"15Gi"},"resources":{"limits":{"cpu":"2","memory":"2Gi"},"requests":{"cpu":"1","memory":"2Gi"}},"rabbitmq":{},"tls":{},"override":{},"terminationGracePeriodSeconds":604800},"status":{"conditions":[{"type":"AllReplicasReady","status":"True","lastTransitionTime":"2021-06-22T07:33:05Z","reason":"AllPodsAreReady"},{"type":"ClusterAvailable","status":"True","lastTransitionTime":"2021-06-22T07:33:05Z","reason":"AtLeastOneEndpointAvailable"},{"type":"NoWarnings","status":"True","lastTransitionTime":"2021-06-22T07:32:01Z","reason":"NoWarnings"},{"type":"ReconcileSuccess","status":"True","lastTransitionTime":"2021-06-22T07:33:06Z","reason":"Success","message":"Finish reconciling"}],"defaultUser":{"secretReference":{"name":"rabbitmq-cluster-default-user","namespace":"default","keys":{"password":"password","username":"username"}},"serviceReference":{"name":"rabbitmq-cluster","namespace":"default"}}}}`
	assert.True(t, isCrucial(strToMap(crucialEvent), strToMap(currentEvent)), "Crucial event detect fail")
}
